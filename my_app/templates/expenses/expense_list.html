{% load static %}
<head>
  <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
</head>

{% block content %}
<body>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      var longTermCheckbox = $('#id_long_term');
      var longTermFields = $('#interest_rate, #end_date');

      longTermFields.hide();

      longTermCheckbox.on('change', function () {
        if (longTermCheckbox.is(':checked')) {
          longTermFields.show();
        } else {
          longTermFields.hide();
        }
      });

      if (longTermCheckbox.is(':checked')) {
        longTermFields.show();
      }

      $('#expense-form').on('submit', function (event) {
        event.preventDefault();
        var formData = $(this).serialize();

        $.ajax({
          url: '{% url "expenses" %}',  <!-- Ensure your URL pattern is correct -->
          type: 'POST',
          data: formData,
          success: function (response) {
            if (response.success) {
              $('#expense-list').append(response.html);  <!-- This is where your expense item HTML will be appended -->
              Plotly.newPlot('plotly-chart', response.graphData.data, response.graphData.layout);
              $('#expense-form')[0].reset();
            }
          },
          error: function (xhr, errmsg, err) {
            alert('Error occurred while adding the expense!');
          }
        });
      });
    });
  </script>

  <div class="main-container">
    <div class="header" style="display: flex; justify-content: center; align-items: center; height: 150px;">
      <img src="{% static 'images/logo.png' %}" alt="Logo" class="logo" style="width: 150px; height: auto;">
    </div>   

    <div class="content-container">
      
      <div class="graph-container">
        <h2>Monthly Expenses Bar Chart</h2>
        <div class="plotly-chart" id="plotly-chart"></div>
      </div>

      <div class="expense-list-container">
        <h2>Expense List</h2>
        <div class="expense-list">
          <ul id="expense-list">
            {% for year_month, liabilities in expense_data.items %}
              <div class="month-section">
                <h3>Month: {{ year_month }}</h3>
                {% for liability in liabilities %}
                  <div class="expense-item">
                    <h4>{{ liability.name }}</h4>
                    {% if liability.long_term %}
                      <p>Date From: {{ liability.date }} <br>To: {{ liability.end_date }}</p>
                    {% else %}
                      <p>Date: {{ liability.date }}</p>
                    {% endif %}
                    <p>Amount: ${{ liability.amount }}</p>
                  </div>
                  <br>
                {% endfor %}
              </div>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <div class="form-container">
      <h2>Add Long Term Liability or Daily Expense</h2>
      <form id="expense-form" method="POST">
        {% csrf_token %}
        
        <div class="form-group">
          {{ form.long_term.label_tag }}
          {{ form.long_term }}
        </div>

        <div class="form-group">
          {{ form.name.label_tag }}
          {{ form.name }}
        </div>

        <div class="form-group">
          {{ form.amount.label_tag }}
          {{ form.amount }}
        </div>

        <div class="form-group">
          {{ form.date.label_tag }}
          {{ form.date }}
        </div>

        <div id="end_date" class="form-group">
          {{ form.end_date.label_tag }}
          {{ form.end_date }}
        </div>

        <div id="interest_rate" class="form-group">
          {{ form.interest_rate.label_tag }}
          {{ form.interest_rate }}
        </div>

        <button type="submit" class="btn btn-success">Add Liability</button>
      </form>
    </div>
  </div>

  <script>
    var graphData = {{ graph_data|safe }};
    Plotly.newPlot('plotly-chart', graphData.data, graphData.layout);
  </script>
</body>
{% endblock %}
